name: Build and Release Signed APK

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*' # 触发标签，例如 v1.0.0

jobs:
  release-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 从 gradle.properties 提取依赖的 Rust 版本号
      - name: Get Rust Lib Version
        run: |
          RUST_TAG=$(grep "rust_libs_version" gradle.properties | cut -d'=' -f2 | xargs)
          echo "RUST_TAG=$RUST_TAG" >> $GITHUB_ENV

      # 2. 设置 JDK 环境
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. 下载后端 Rust 编译好的 .so 产物（4 种架构）
      - name: Fetch Rust Binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ABIS=("arm64-v8a" "armeabi-v7a" "x86_64" "x86")
          for ABI in "${ABIS[@]}"; do
            mkdir -p app/src/main/jniLibs/$ABI
            # 下载并将 libktv_casting_lib-[ABI].so 重命名为 libktv_casting_lib.so
            gh release download ${{ env.RUST_TAG }} \
              --repo StarFreedomX/ktv-casting \
              --pattern "libktv_casting_lib-$ABI.so" \
              --output app/src/main/jniLibs/$ABI/libktv_casting_lib.so
          done

      # 4. 还原签名文件 (从 Secret 的 Base64 字符串转回 .jks 文件)
      - name: Decode Keystore
        run: echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > app/release.jks

      # 5. 执行自定义的 packRelease 任务
      - name: Build Release APK
        env:
          STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          chmod +x gradlew
          ./gradlew packRelease \
          -Pandroid.injected.signing.store.file="$GITHUB_WORKSPACE/app/release.jks" \
          -Pandroid.injected.signing.store.password="$STORE_PASSWORD" \
          -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
          -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
          
      # 6. 创建 GitHub Release 并上传 apks 文件夹下的新文件名文件
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          # 指向根目录下的 apks 文件夹，抓取改名后的所有 APK
          files: apks/*.apk
          generate_release_notes: true
          body: |
            ### KTV Casting Android App Release
            - **App Version**: `${{ github.ref_name }}`
            - **Rust Engine Version**: `${{ env.RUST_TAG }}`